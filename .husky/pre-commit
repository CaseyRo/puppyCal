#!/usr/bin/env sh
# Pre-commit hook for CDIT Footer
# Runs quality checks before allowing commits

set -e

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any markdown files were changed
if echo "$STAGED_FILES" | grep -qE '\.(md)$'; then
  echo "üìù Linting changed Markdown files..."
  # Only lint the changed markdown files
  CHANGED_MD_FILES=$(echo "$STAGED_FILES" | grep -E '\.(md)$' | grep -vE '^\.(claude|cursor)/' || true)
  if [ -n "$CHANGED_MD_FILES" ]; then
    echo "$CHANGED_MD_FILES" | xargs npx markdownlint-cli2 || exit 1
    echo "‚úì Markdown linting passed"
  fi
fi

# Check if any TypeScript files were changed
if echo "$STAGED_FILES" | grep -qE '\.(ts|tsx|astro)$'; then
  echo "üî∑ Type checking TypeScript files..."
  npm run typecheck || exit 1
  echo "‚úì Type checking passed"
fi

# Check if any config files were changed
if echo "$STAGED_FILES" | grep -qE '\.(config|config\.ts)$|examples/.*\.ts$'; then
  echo "‚úÖ Validating footer config files..."
  
  # Validate all config files in examples directory
  for config_file in examples/*.config.ts; do
    if [ -f "$config_file" ]; then
      echo "  Validating $config_file..."
      npm run validate-config -- "$config_file" || exit 1
    fi
  done
  
  echo "‚úì Config validation passed"
fi

# Run tests if they exist (currently placeholder)
if echo "$STAGED_FILES" | grep -qE '\.(ts|tsx|astro)$|src/'; then
  echo "üß™ Running tests..."
  npm test || exit 1
  echo "‚úì Tests passed"
fi

echo "‚ú® All pre-commit checks passed!"
